<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>AltStore風ストア</title>
<style>
body { font-family: sans-serif; background:#f5f5f5; color:#222; margin:0; padding:0;}
header { background:#222; color:#fff; padding:10px 20px; display:flex; align-items:center; justify-content:space-between;}
h1 { margin:0; font-size:1.5em; }
.container { padding:20px; }
.repo-toggle, .search-box { margin-bottom:15px; }
.repo-toggle label { margin-right:15px; cursor:pointer; }
.app { display:flex; align-items:center; background:#fff; padding:10px 15px; margin-bottom:10px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.2);}
.app img { width:60px; height:60px; border-radius:12px; margin-right:15px; object-fit:cover; }
.app .info { flex:1; }
.app .info h2 { margin:0 0 5px 0; font-size:1.2em; }
.app .meta { font-size:0.9em; color:#555; }
button { padding:5px 10px; border:none; border-radius:5px; background:#007bff; color:#fff; cursor:pointer;}
button:hover { background:#0056b3;}
input[type="text"] { padding:5px 8px; border-radius:5px; border:1px solid #ccc; width:250px;}
#error { color:red; font-weight:bold; margin-bottom:15px; white-space: pre-wrap;}
</style>
</head>
<body>
<header>
<h1>AltStore風ストア</h1>
<div class="search-box">
<input type="text" id="searchInput" placeholder="アプリ名で検索">
</div>
</header>
<div class="container">
<div id="error"></div>
<div id="repoToggles" class="repo-toggle"></div>
<div id="apps"></div>
</div>
<script>
const repoUrls = [
  "https://corsproxy.io/?url=https://ipa.cypwn.xyz/cypwn.json"
];

let reposData = [];
let enabledRepos = {};

function createRepoToggles() {
  const container = document.getElementById('repoToggles');
  container.innerHTML = '';
  reposData.forEach(repo => {
    const id = repo.name || repo.identifier || "unknown";
    enabledRepos[id] = true;
    const label = document.createElement('label');
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.checked = true;
    cb.onchange = () => { enabledRepos[id] = cb.checked; renderApps(); };
    label.appendChild(cb);
    label.appendChild(document.createTextNode(' ' + id));
    container.appendChild(label);
  });
}

function renderApps() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const appsDiv = document.getElementById('apps');
  appsDiv.innerHTML = '';
  reposData.forEach(repo => {
    const repoId = repo.name || repo.identifier || "unknown";
    if(!enabledRepos[repoId]) return;

    const apps = Array.isArray(repo.apps) ? repo.apps : Object.values(repo.apps || {});
    apps.forEach(app => {
      if(searchTerm && !(app.name && app.name.toLowerCase().includes(searchTerm))) return;

      const appDiv = document.createElement('div');
      appDiv.className = 'app';

      // アイコン
      const img = document.createElement('img');
      img.src = app.iconURL || '';
      img.alt = app.name || 'app icon';
      appDiv.appendChild(img);

      // info
      const info = document.createElement('div');
      info.className = 'info';
      const title = document.createElement('h2');
      title.textContent = app.name || app.bundleIdentifier || 'Unknown App';
      info.appendChild(title);

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = `Version: ${app.version || 'N/A'} | Updated: ${app.versionDate || 'N/A'} | Developer: ${app.developerName || 'N/A'}`;
      info.appendChild(meta);

      appDiv.appendChild(info);

      // ダウンロードボタン
      if(app.downloadURL) {
        const btn = document.createElement('button');
        btn.textContent = 'Download IPA';
        btn.onclick = () => { window.open(app.downloadURL, '_blank'); };
        appDiv.appendChild(btn);
      }

      appsDiv.appendChild(appDiv);
    });
  });
}

async function fetchRepos() {
  reposData = [];
  let success = false;
  let errorMessages = [];
  for(const url of repoUrls) {
    try {
      const res = await fetch(url);
      if(!res.ok) { 
        errorMessages.push(`Failed to fetch: ${url} (status ${res.status})`);
        continue;
      }
      const data = await res.json();
      reposData.push(data);
      success = true;
    } catch(e) {
      console.error('Error fetching:', url, e);
      errorMessages.push(`Error fetching: ${url}\n${e.message}`);
    }
  }

  const errorDiv = document.getElementById('error');
  if(!success) {
    errorDiv.textContent = "JSONを読み込めませんでした。\n" + errorMessages.join("\n");
  } else {
    errorDiv.textContent = "";
  }

  createRepoToggles();
  renderApps();
}

document.getElementById('searchInput').addEventListener('input', renderApps);

fetchRepos();
</script>
</body>
</html>
