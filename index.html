<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ipa-viewer</title>
<style>
body { font-family: sans-serif; background:#f5f5f5; color:#222; margin:0; padding:0;}
header { background:#222; color:#fff; padding:10px 20px; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap;}
h1 { margin:0; font-size:1.5em; }
.container { padding:20px; }
.repo-toggle, .search-box { margin-bottom:15px; }
.repo-toggle label { margin-right:15px; cursor:pointer; }
.app { display:flex; align-items:center; background:#fff; padding:10px 15px; margin-bottom:10px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.2);}
.app img { width:60px; height:60px; border-radius:12px; margin-right:15px; object-fit:cover; }
.app .info { flex:1; }
.app .info h2 { margin:0 0 5px 0; font-size:1.2em; }
.app .meta { font-size:0.9em; color:#555; margin-bottom:5px; }
button { padding:5px 10px; border:none; border-radius:5px; background:#007bff; color:#fff; cursor:pointer; margin-right:5px; }
button:hover { background:#0056b3; }
input[type="text"] { padding:5px 8px; border-radius:5px; border:1px solid #ccc; width:250px;}
#error { color:red; font-weight:bold; margin-bottom:15px; white-space: pre-wrap; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:1000; }
.modal-content { background:#fff; padding:20px; border-radius:10px; max-width:600px; max-height:80%; overflow:auto; }
.modal img { max-width:500px; height:auto; margin-bottom:10px; border-radius:8px; display:block; }
.modal-close { float:right; cursor:pointer; font-weight:bold; color:#333; }
</style>
</head>
<body>
<header>
<h1>ipa-viewer</h1>
<div class="search-box">
<input type="text" id="searchInput" placeholder="アプリ名で検索">
</div>
</header>
<div class="container">
<div id="error"></div>
<div id="repoToggles" class="repo-toggle"></div>
<div id="apps"></div>
</div>

<!-- モーダル -->
<div id="modal" class="modal">
<div class="modal-content">
<span id="modalClose" class="modal-close">✖</span>
<div id="modalBody"></div>
</div>
</div>

<script>
const repoUrls = [
  "https://ipa.cypwn.xyz/cypwn.json"
];

const corsProxy = "https://corsproxy.io/?url=";
let reposData = [];
let enabledRepos = {};

// repo ON/OFF
function createRepoToggles() {
  const container = document.getElementById('repoToggles');
  container.innerHTML = '';
  reposData.forEach(repo => {
    const id = repo.name || repo.identifier || "unknown";
    enabledRepos[id] = true;
    const label = document.createElement('label');
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.checked = true;
    cb.onchange = () => { enabledRepos[id] = cb.checked; renderApps(); };
    label.appendChild(cb);
    label.appendChild(document.createTextNode(' ' + id));
    container.appendChild(label);
  });
}

// アプリ描画
function renderApps() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const appsDiv = document.getElementById('apps');
  appsDiv.innerHTML = '';
  reposData.forEach(repo => {
    const repoId = repo.name || repo.identifier || "unknown";
    if(!enabledRepos[repoId]) return;

    const apps = Array.isArray(repo.apps) ? repo.apps : Object.values(repo.apps || {});
    apps.forEach(app => {
      if(searchTerm && !(app.name && app.name.toLowerCase().includes(searchTerm))) return;

      const appDiv = document.createElement('div');
      appDiv.className = 'app';

      const img = document.createElement('img');
      img.src = app.iconURL ? corsProxy + app.iconURL : '';
      img.alt = app.name || 'app icon';
      appDiv.appendChild(img);

      const info = document.createElement('div');
      info.className = 'info';
      const title = document.createElement('h2');
      title.textContent = app.name || app.bundleIdentifier || 'Unknown App';
      info.appendChild(title);

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = `Version: ${app.version || 'N/A'} | Updated: ${app.versionDate || 'N/A'} | Developer: ${app.developerName || 'N/A'}`;
      info.appendChild(meta);

      appDiv.appendChild(info);

      // ボタン群
      if(app.downloadURL){
        const btn = document.createElement('button');
        btn.textContent = 'Download IPA';
        btn.onclick = () => window.open(corsProxy + app.downloadURL, '_blank');
        appDiv.appendChild(btn);
      }

      if(app.localizedDescription || (app.screenshotURLs && app.screenshotURLs.length)){
        const btnDetail = document.createElement('button');
        btnDetail.textContent = '詳細';
        btnDetail.onclick = () => openModal(app);
        appDiv.appendChild(btnDetail);
      }

      appsDiv.appendChild(appDiv);
    });
  });
}

// モーダル制御
const modal = document.getElementById('modal');
const modalBody = document.getElementById('modalBody');
document.getElementById('modalClose').onclick = () => { modal.style.display='none'; };

function openModal(app){
  modalBody.innerHTML = '';
  if(app.localizedDescription){
    const p = document.createElement('p');
    p.textContent = app.localizedDescription;
    modalBody.appendChild(p);
  }
  if(app.screenshotURLs && app.screenshotURLs.length){
    app.screenshotURLs.forEach(url=>{
      const img = document.createElement('img');
      img.src = corsProxy + url;
      modalBody.appendChild(img);
    });
  }
  modal.style.display = 'flex';
}

// JSON fetch
async function fetchRepos() {
  reposData = [];
  let success = false;
  let errorMessages = [];
  for(const url of repoUrls){
    try{
      const res = await fetch(corsProxy + url);
      if(!res.ok){
        errorMessages.push(`Failed to fetch: ${url} (status ${res.status})`);
        continue;
      }
      const data = await res.json();
      reposData.push(data);
      success = true;
    } catch(e){
      console.error('Error fetching:', url, e);
      errorMessages.push(`Error fetching: ${url}\n${e.message}`);
    }
  }

  const errorDiv = document.getElementById('error');
  if(!success){
    errorDiv.textContent = "JSONを読み込めませんでした。\n" + errorMessages.join("\n");
  } else {
    errorDiv.textContent = "";
  }

  createRepoToggles();
  renderApps();
}

document.getElementById('searchInput').addEventListener('input', renderApps);
fetchRepos();
</script>
</body>
</html>
